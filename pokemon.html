<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Card Batch Pricer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .upload-btn:hover {
            transform: scale(1.05);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .batch-info {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .preview-section {
            display: none;
            margin-bottom: 30px;
        }
        
        .card-preview {
            max-width: 300px;
            margin: 0 auto 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card-preview img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .identification-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .verification-checkboxes {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .checkbox-item:hover {
            background: #e9ecef;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
            color: #333;
        }
        
        .grade-selector {
            margin-left: 30px;
            margin-top: 8px;
            display: none;
        }
        
        .grade-selector.active {
            display: block;
        }
        
        .grade-selector select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 150px;
        }
        
        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .search-btn:hover {
            transform: scale(1.02);
        }
        
        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
        }
        
        .price-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .price-summary h2 {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .price-summary .price {
            font-size: 48px;
            font-weight: 700;
        }
        
        .comparables {
            margin-top: 25px;
        }
        
        .comparables h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .comparable-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comparable-title {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
        
        .comparable-price {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            margin-left: 15px;
        }
        
        .navigation-btns {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .new-batch-btn {
            background: #e9ecef;
            color: #333;
        }
        
        .nav-btn:hover {
            transform: scale(1.02);
        }
        
        .progress-indicator {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin: 20px 0;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ Pokemon Card Batch Pricer</h1>
        <p class="subtitle">Upload multiple cards, verify details, get accurate eBay pricing</p>
        
        <div class="upload-section" id="uploadSection">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ðŸ“¸ Select Card Photos</button>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <div class="batch-info">Select multiple photos to process as a batch</div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <div class="progress-indicator" id="progressIndicator"></div>
            
            <div class="card-preview" id="cardPreview">
                <img id="previewImage" src="" alt="Card">
            </div>
            
            <div id="loadingMessage" class="loading" style="display: none;">
                Identifying card...
            </div>
            
            <div id="errorMessage" class="error" style="display: none;"></div>
            
            <div class="identification-section" id="identificationSection" style="display: none;">
                <div class="card-name" id="cardName"></div>
                
                <div class="verification-checkboxes">
                    <div class="checkbox-item">
                        <input type="checkbox" id="firstEdition">
                        <label for="firstEdition">1st Edition</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="shadowless">
                        <label for="shadowless">Shadowless</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="holo">
                        <label for="holo">Holographic</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="reverseHolo">
                        <label for="reverseHolo">Reverse Holo</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="graded" onchange="toggleGradeSelector()">
                        <label for="graded">PSA/BGS Graded</label>
                    </div>
                    
                    <div class="grade-selector" id="gradeSelector">
                        <select id="gradeValue">
                            <option value="">Select Grade</option>
                            <option value="PSA 10">PSA 10</option>
                            <option value="PSA 9">PSA 9</option>
                            <option value="PSA 8">PSA 8</option>
                            <option value="PSA 7">PSA 7</option>
                            <option value="BGS 10">BGS 10</option>
                            <option value="BGS 9.5">BGS 9.5</option>
                            <option value="BGS 9">BGS 9</option>
                            <option value="BGS 8.5">BGS 8.5</option>
                        </select>
                    </div>
                </div>
                
                <button class="search-btn" id="searchBtn" onclick="searchEbay()">
                    Search eBay Sold Listings
                </button>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="price-summary">
                <h2>Suggested Price</h2>
                <div class="price" id="suggestedPrice">--</div>
            </div>
            
            <div class="comparables">
                <h3>Recent Sold Listings</h3>
                <div id="comparablesList"></div>
            </div>
            
            <div class="navigation-btns">
                <button class="nav-btn next-btn" id="nextBtn" onclick="nextCard()">
                    Next Card â†’
                </button>
                <button class="nav-btn new-batch-btn" onclick="newBatch()">
                    New Batch
                </button>
            </div>
        </div>
    </div>

    <script>
        let cardBatch = [];
        let currentCardIndex = 0;
        let currentIdentification = null;

        const EBAY_APP_ID = 'BrianGal-PriceToo-PRD-6c2c86c48-5b0c4b93';

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            cardBatch = files.map(file => ({
                file: file,
                url: URL.createObjectURL(file),
                identification: null,
                results: null
            }));

            currentCardIndex = 0;
            showCard(0);
        }

        function showCard(index) {
            if (index >= cardBatch.length) {
                alert('All cards processed!');
                return;
            }

            currentCardIndex = index;
            const card = cardBatch[index];

            // Update UI
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressIndicator').textContent = `Card ${index + 1} of ${cardBatch.length}`;
            document.getElementById('previewImage').src = card.url;

            // Reset checkboxes
            resetCheckboxes();

            // Identify card
            identifyCard(card.file);
        }

        function resetCheckboxes() {
            document.getElementById('firstEdition').checked = false;
            document.getElementById('shadowless').checked = false;
            document.getElementById('holo').checked = false;
            document.getElementById('reverseHolo').checked = false;
            document.getElementById('graded').checked = false;
            document.getElementById('gradeSelector').classList.remove('active');
            document.getElementById('gradeValue').value = '';
        }

        function toggleGradeSelector() {
            const gradeSelector = document.getElementById('gradeSelector');
            const gradedCheckbox = document.getElementById('graded');
            
            if (gradedCheckbox.checked) {
                gradeSelector.classList.add('active');
            } else {
                gradeSelector.classList.remove('active');
                document.getElementById('gradeValue').value = '';
            }
        }

        async function identifyCard(file) {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('identificationSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                const base64 = await fileToBase64(file);
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: file.type,
                                        data: base64
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this Pokemon card image carefully. Identify:
1. Card name
2. Set name
3. Is it 1st Edition? (look for the "1st Edition" stamp)
4. Is it Shadowless? (Base Set cards without shadow on right side)
5. Is it Holographic?
6. Is it Reverse Holo?
7. Is it graded (PSA/BGS)? If so, what grade?

Respond in this exact format:
Card: [name]
Set: [set name]
1st Edition: [yes/no]
Shadowless: [yes/no]
Holographic: [yes/no]
Reverse Holo: [yes/no]
Graded: [yes/no or PSA 10, BGS 9.5, etc.]`
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const analysis = data.content[0].text;
                
                parseIdentification(analysis);

            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error identifying card: ' + error.message;
            }
        }

        function parseIdentification(analysis) {
            const lines = analysis.split('\n');
            const cardLine = lines.find(l => l.startsWith('Card:'));
            const setLine = lines.find(l => l.startsWith('Set:'));
            const firstEdLine = lines.find(l => l.startsWith('1st Edition:'));
            const shadowlessLine = lines.find(l => l.startsWith('Shadowless:'));
            const holoLine = lines.find(l => l.startsWith('Holographic:'));
            const reverseHoloLine = lines.find(l => l.startsWith('Reverse Holo:'));
            const gradedLine = lines.find(l => l.startsWith('Graded:'));

            const cardName = cardLine ? cardLine.split(':')[1].trim() : 'Unknown Card';
            const setName = setLine ? setLine.split(':')[1].trim() : '';

            currentIdentification = {
                card: cardName,
                set: setName
            };

            // Display identification
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('identificationSection').style.display = 'block';
            document.getElementById('cardName').textContent = `${cardName}${setName ? ' - ' + setName : ''}`;

            // Pre-check boxes based on AI detection
            if (firstEdLine && firstEdLine.toLowerCase().includes('yes')) {
                document.getElementById('firstEdition').checked = true;
            }
            if (shadowlessLine && shadowlessLine.toLowerCase().includes('yes')) {
                document.getElementById('shadowless').checked = true;
            }
            if (holoLine && holoLine.toLowerCase().includes('yes')) {
                document.getElementById('holo').checked = true;
            }
            if (reverseHoloLine && reverseHoloLine.toLowerCase().includes('yes')) {
                document.getElementById('reverseHolo').checked = true;
            }
            if (gradedLine && !gradedLine.toLowerCase().includes('no')) {
                const gradeMatch = gradedLine.match(/(PSA|BGS)\s*[\d.]+/i);
                if (gradeMatch) {
                    document.getElementById('graded').checked = true;
                    toggleGradeSelector();
                    const gradeValue = gradeMatch[0].toUpperCase();
                    document.getElementById('gradeValue').value = gradeValue;
                }
            }
        }

        async function searchEbay() {
            if (!currentIdentification) return;

            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').textContent = 'Searching...';

            // Build search query
            let query = currentIdentification.card;
            if (currentIdentification.set) query += ' ' + currentIdentification.set;
            
            if (document.getElementById('firstEdition').checked) query += ' 1st Edition';
            if (document.getElementById('shadowless').checked) query += ' Shadowless';
            if (document.getElementById('holo').checked) query += ' Holo';
            if (document.getElementById('reverseHolo').checked) query += ' Reverse Holo';
            if (document.getElementById('graded').checked) {
                const grade = document.getElementById('gradeValue').value;
                if (grade) query += ' ' + grade;
            }

            query += ' Pokemon Card';

            try {
                const url = `https://svcs.ebay.com/services/search/FindingService/v1?OPERATION-NAME=findCompletedItems&SERVICE-VERSION=1.0.0&SECURITY-APPNAME=${EBAY_APP_ID}&RESPONSE-DATA-FORMAT=JSON&REST-PAYLOAD&keywords=${encodeURIComponent(query)}&itemFilter(0).name=SoldItemsOnly&itemFilter(0).value=true&itemFilter(1).name=ListingType&itemFilter(1).value(0)=Auction&itemFilter(1).value(1)=FixedPrice&sortOrder=EndTimeSoonest&paginationInput.entriesPerPage=20`;

                const response = await fetch(url);
                const data = await response.json();
                
                const items = data.findCompletedItemsResponse?.[0]?.searchResult?.[0]?.item || [];
                
                if (items.length === 0) {
                    throw new Error('No sold listings found');
                }

                displayResults(items);

            } catch (error) {
                alert('Error searching eBay: ' + error.message);
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'Search eBay Sold Listings';
            }
        }

        function displayResults(items) {
            const prices = items
                .map(item => parseFloat(item.sellingStatus[0].currentPrice[0].__value__))
                .filter(p => !isNaN(p) && p > 0)
                .sort((a, b) => a - b);

            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

            document.getElementById('suggestedPrice').textContent = '$' + avgPrice.toFixed(2);

            const comparablesList = document.getElementById('comparablesList');
            comparablesList.innerHTML = '';

            items.slice(0, 10).forEach(item => {
                const price = parseFloat(item.sellingStatus[0].currentPrice[0].__value__);
                const title = item.title[0];

                const div = document.createElement('div');
                div.className = 'comparable-item';
                div.innerHTML = `
                    <div class="comparable-title">${title}</div>
                    <div class="comparable-price">$${price.toFixed(2)}</div>
                `;
                comparablesList.appendChild(div);
            });

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            // Update next button text
            const nextBtn = document.getElementById('nextBtn');
            if (currentCardIndex < cardBatch.length - 1) {
                nextBtn.textContent = 'Next Card â†’';
                nextBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'none';
            }

            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').textContent = 'Search eBay Sold Listings';
        }

        function nextCard() {
            if (currentCardIndex < cardBatch.length - 1) {
                showCard(currentCardIndex + 1);
            }
        }

        function newBatch() {
            cardBatch = [];
            currentCardIndex = 0;
            currentIdentification = null;
            
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>